#!/usr/bin/env bash
set -e

bold=1
red=31
green=32
yellow=33
magenta=35
cyan=36
gray=90

echo_color() {
  local color="$1"
  shift
  local message="$@"

  if is_interactive; then
    echo -e "\033[${color}m${message}\033[0m"
  else
    echo "$message"
  fi
}

escape() {
  local value="$1"
  echo "$value" | sed 's/[.[\*^$()+?{|]/\\&/g'
}

is_interactive() {
  test "${-#*i}" != "$-" || test -t 0 || test -n "$PS1"
}

get_config_group() {
  local group="$1"

  echo "$config" \
    | grep "^\[$group\]$" -A 999 \
    | tail -n +2 \
    | grep -v "^ *#" \
    | grep -v "^ *$" \
    | sed "/^\[/q" \
    | sed "/^\[/d"
}

get_config_values_in_group() {
  local group="$1"
  local key="$(escape "$2")"
  local operator="$(escape "$3")"

  get_config_group $group \
    | grep "^$key  *$operator  *" \
    | cut -d ' ' -f 2-999 \
    | sed "s/^ *//" \
    | sed "s/^$operator *//" \
    | sed "s/ *$//"
}

filter_versions() {
  local subject="$1"
  local plugin="$2"
  local operator="$3"

  grep_options="-E"
  if echo "$operator" | grep -E '^\!' &>/dev/null; then
    grep_options="$grep_options -v"
  fi

  for regexp in `get_config_values_in_group "versions" "$plugin" "$operator"`; do
    test -n "$regexp" && subject="$(echo "$subject" | grep $grep_options -- "$regexp")"
  done

  printf "$subject"
}

longest_column() {
  local text="$1"
  local column="$2"

  echo "$text" | \
    tr -s ' ' | \
    cut -d ' ' -f "$column" | \
    awk '{ print length, $0 }' | \
    sort -n -r -s | \
    head -n 1 | \
    cut -d ' ' -f 1
}

confirm() {
  local prompt="$1"
  printf "$prompt"
  read input
  printf "$input" | grep -E -i "^(n|no)$" >/dev/null && return 1
  printf "$input" | grep -E -i "^(y|yes)$" >/dev/null && return 0
  confirm "$prompt"
}

config=
test -f ~/.update-all-asdf-tools && config=`cat ~/.update-all-asdf-tools`

echo
echo "Checking available updates..."
current_versions=`asdf current`

longest_plugin_name=`longest_column "$current_versions" 1`
longest_version_name=`longest_column "$current_versions" 2`

updates=()

OLD_IFS="$IFS"
IFS=$'\n'
for current_version in $current_versions; do
  IFS="$OLD_IFS"

  trimmed="$(echo "$current_version"|tr -s ' ')"
  plugin="$(echo "$trimmed"|cut -d ' ' -f 1)"
  version="$(echo "$trimmed"|cut -d ' ' -f 2)"

  separator="   "
  padded_plugin="$(printf "%-${longest_plugin_name}s" "$plugin")"
  padded_version="$(printf "%-${longest_version_name}s" "$version")"
  printf "$(echo_color $bold "$padded_plugin")${separator}${padded_version}"

  fixed_version=`get_config_values_in_group "versions" "$plugin" "=" | tail -n 1`

  available_versions=`asdf list all $plugin`
  available_versions=`filter_versions "$available_versions" "*" "=~"`
  available_versions=`filter_versions "$available_versions" "$plugin" "=~"`
  available_versions=`filter_versions "$available_versions" "*" "!=~"`
  available_versions=`filter_versions "$available_versions" "$plugin" "!=~"`
  latest_version="$(echo "$available_versions" | tail -n 1)"

  if test -n "$fixed_version"; then
    printf "${separator}$(echo_color $cyan fixed)   "
    if [[ "$latest_version" != "$fixed_version" ]]; then
      echo "${separator}$(echo_color $gray "$latest_version available")"
    fi
  elif [[ "$latest_version" == "" ]]; then
    echo "${separator}$(echo_color $red no matching version found)"
  elif [[ "$version" == "$latest_version" ]]; then
    echo "${separator}$(echo_color $green latest)  "
  else
    updates+=( "$plugin $latest_version" )
    echo "${separator}$(echo_color $yellow outdated)${separator}${latest_version} available"
  fi

  IFS=$'\n'
done

IFS="$OLD_IFS"

if [[ ${#updates[@]} -eq 0 ]]; then
  echo
  echo_color $green "No updates available."

  echo
  exit 0
fi

echo
echo "Updates found: ${#updates[@]}"
confirm "Proceed? [yes/no] " || exit 0

echo "Not yet implemented"
echo
